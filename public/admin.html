<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin · 100 Leute gefragt</title>
  <link rel="stylesheet" href="/style.css" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
<div class="container">
  <div class="header">
    <h1 class="h">Admin-Panel <span class="small">(alle Antworten sichtbar)</span></h1>
    <div class="controls">
      <button class="btn" id="btnDraw">Startteam auslosen</button>
      <button class="btn" id="btnNext">Nächste Runde</button>

      <!-- NEU: Gewinner-Anzeige (Konfetti/Krone bei allen Clients) -->
      <select class="input" id="winTeam" style="min-width:auto">
        <option value="A">Gewinner: Team Rot (A)</option>
        <option value="B">Gewinner: Team Blau (B)</option>
      </select>
      <button class="btn ok" id="btnCelebrate">Gewinner-Team anzeigen</button>

      <button class="btn warn" id="btnReload">Fragen neu laden</button>
    </div>
  </div>

  <!-- NEU: Zug-Banner -->
  <div id="turnBanner" class="notice" style="display:none; margin-bottom:12px;">—</div>

  <div class="row">
    <!-- Linke Spalte: Spieler & Spy-Chat -->
    <div class="card" style="flex:2">
      <h2 class="h">Spieler & Teams</h2>
      <div id="players" class="list"></div>

      <h2 class="h" style="margin-top:10px">Team-Chats (live)</h2>
      <div class="small">Admin sieht beide Team-Chats in Echtzeit</div>
      <div id="spy" class="list" style="max-height:220px; overflow:auto"></div>
    </div>

    <!-- Rechte Spalte: Brett & Antworten -->
    <div class="card" style="flex:3">
      <h2 class="h">Brett</h2>
      <div id="board" class="board"></div>

      <div id="answers" style="margin-top:12px"></div>

      <div class="controls" style="margin-top:10px">
        <input id="awId" class="input" placeholder="Spieler-ID" />
        <input id="awVal" class="input" type="number" value="10" />
        <button class="btn ok" id="btnAward">Punkte an Spieler</button>
        <button class="btn" id="btnForce">Feld schließen</button>
      </div>
    </div>
  </div>
</div>

<!-- Audios: preload auf 'none' (Server liefert Fallback, falls MP3 fehlt) -->
<audio id="sfxCorrect" src="/sfx/correct.mp3" preload="none"></audio>
<audio id="sfxWrong"   src="/sfx/wrong.mp3"   preload="none"></audio>

<script>
const socket = io();
socket.emit('role:admin');

let lastTile = null;           // {ci, ii}
let adminBoardCache = null;
let currentTurnTeam = null;    // 'A' | 'B' | null
let lastPlayersCache = [];     // für Re-Highlight

// Mini-Helper
function el(t, attrs={}, ...children){
  const e = document.createElement(t);
  Object.entries(attrs).forEach(([k,v]) => e.setAttribute(k, v));
  children.forEach(c => e.appendChild(typeof c==='string' ? document.createTextNode(c) : c));
  return e;
}

// Refs
const playersDiv = document.getElementById('players');
const boardDiv   = document.getElementById('board');
const answersDiv = document.getElementById('answers');
const spyDiv     = document.getElementById('spy');
const turnBanner = document.getElementById('turnBanner');

// NEU: Zug-UI aktualisieren (Banner + Body-Klasse + Player-Highlight)
function updateTurnUI(team){
  currentTurnTeam = (team === 'A' || team === 'B') ? team : null;

  document.body.classList.remove('turnA','turnB');
  if (currentTurnTeam){
    document.body.classList.add(currentTurnTeam === 'A' ? 'turnA' : 'turnB');
    turnBanner.style.display = 'block';
    turnBanner.textContent = `Am Zug: ${currentTurnTeam === 'A' ? 'Team Rot' : 'Team Blau'}`;
  } else {
    turnBanner.style.display = 'none';
  }

  // Spieler-Re-Render, um aktives Team zu markieren
  if (lastPlayersCache?.length) renderPlayers(lastPlayersCache);
}

// Spieler rendern (markiert Team am Zug)
function renderPlayers(players){
  lastPlayersCache = players || [];
  playersDiv.innerHTML = '';
  lastPlayersCache.forEach(p => {
    const cls = ['player', (p.team==='A' ? 'teamA' : 'teamB')];
    if (currentTurnTeam && p.team === currentTurnTeam) cls.push('active');
    const row = el('div', { class: cls.join(' ') },
      el('div', {}, `${p.name} · Team ${p.team}`,
        ...(currentTurnTeam && p.team===currentTurnTeam ? [el('span',{class:'team-pill', style:'margin-left:8px'}, 'Am Zug')] : [])
      ),
      el('div', {}, `${p.score} Punkte`)
    );
    row.onclick = () => { document.getElementById('awId').value = p.id; };
    playersDiv.appendChild(row);
  });
}

// Brett rendern (zeigt 1..5 als Label)
function renderBoard(board){
  boardDiv.innerHTML = '';
  board.categories.forEach((cat, ci) => {
    const col = el('div', {});
    col.appendChild(el('div', {class:'cat'}, cat.name));
    const tiles = el('div', {class:'tiles'});
    cat.items.forEach((it, ii) => {
      const used = it.revealed || it.answered;
      const d = el('div', { class: 'tile' + (used ? ' used' : '') }, String(it.points));
      d.onclick = () => {
        if (used) return;
        lastTile = { ci:ci, ii:ii };
        socket.emit('player:pickTile', { catIndex:ci, itemIndex:ii }); // Admin kann Feld öffnen
      };
      tiles.appendChild(d);
    });
    col.appendChild(tiles);
    boardDiv.appendChild(col);
  });
}

// Admin-Ansicht Antworten inkl. Meta, Fehlversuche, Badges, Reveal-All + Als-falsch-werten
function renderAnswersAdmin(ci, ii, admBoard){
  adminBoardCache = admBoard;
  answersDiv.innerHTML = '';
  const item = admBoard?.categories?.[ci]?.items?.[ii];
  if (!item) return;

  // Kopfzeile mit Frage
  answersDiv.appendChild(el('div', {class:'small'}, `Feld ${item.points} · Frage: ${item.q}`));

  // Meta-Zeile: Am Zug, Original, Fehlversuche A/B, Steal-Status
  const stealInfo = item.meta.stealActive
    ? ` · Abstauber: Team ${item.meta.stealTeam ?? '–'} (1 Chance)`
    : '';
  const meta = el('div', {class:'player'},
    el('div', {},
      el('span', {class: 'team-pill ' + (item.meta.turnTeam==='A' ? 'teamA' : 'teamB')},
        `Am Zug: Team ${item.meta.turnTeam ?? '–'}`
      ),
      el('span', {class: 'team-pill', style: 'margin-left:8px'},
        `Original: Team ${item.meta.originalTeam ?? '–'}`
      ),
      el('span', {class: 'team-pill', style: 'margin-left:8px'},
        item.meta.stealActive ? 'Abstauber aktiv' : 'Normalphase'
      ),
      document.createTextNode(stealInfo)
    ),
    el('div', {}, `Fehlversuche A: ${item.meta.wrongA ?? 0}/3 · B: ${item.meta.wrongB ?? 0}/3`)
  );
  answersDiv.appendChild(meta);

  // Antwortenliste (klickbar zum manuellen Reveal)
  item.answers.forEach((a, idx) => {
    const row = el('div', {class:'answer-row ' + (a.revealed ? 'revealed' : '')});
    const left  = el('div', {}, `${idx+1}. ${a.text}`);
    const right = el('div', {}, `${a.percent}%`);

    if (a.byTeam) {
      right.appendChild(
        el('span', {class: 'team-pill ' + (a.byTeam==='A' ? 'teamA' : 'teamB'), style:'margin-left:8px'}, `Team ${a.byTeam}`)
      );
    }

    row.appendChild(left);
    row.appendChild(right);

    if (!a.revealed) {
      row.style.cursor = 'pointer';
      row.title = 'Antwort manuell aufdecken';
      row.onclick = () => socket.emit('admin:revealAnswer', { catIndex:ci, itemIndex:ii, index:idx });
    }

    answersDiv.appendChild(row);
  });

  // Footer-Controls
  const footer = el('div', {class:'controls', style:'margin-top:10px'});

  // Falschantwort zählen (Team am Zug)
  const wrongBtn = el('button', {class:'btn warn', id:'btnMarkWrong'}, 'Als falsch werten (Team am Zug)');
  wrongBtn.onclick = () => socket.emit('admin:markWrong', { catIndex:ci, itemIndex:ii });

  // Alle verbleibenden anzeigen
  const revealAllBtn = el('button', {class:'btn', id:'btnRevealAll'}, 'Alle verbleibenden anzeigen');
  revealAllBtn.onclick = () => {
    item.answers.forEach((a, idx) => {
      if (!a.revealed) socket.emit('admin:revealAnswer', { catIndex:ci, itemIndex:ii, index:idx });
    });
  };

  footer.appendChild(wrongBtn);
  footer.appendChild(revealAllBtn);
  answersDiv.appendChild(footer);
}

// *** Events ***

socket.on('state:update', (data) => {
  renderPlayers(data.players);
  renderBoard(data.board);
});

socket.on('state:admin', (data) => {
  renderPlayers(data.players);
  renderBoard(data.board);
  if (lastTile) renderAnswersAdmin(lastTile.ci, lastTile.ii, data.board);
});

// Globaler Start-Zug & Zugwechsel → Admin-UI markieren
socket.on('turn:global', (p) => {
  updateTurnUI(p.team);
});
socket.on('turn:changed', (p) => {
  updateTurnUI(p.turnTeam || p.team);
  if (lastTile && adminBoardCache) {
    renderAnswersAdmin(lastTile.ci, lastTile.ii, adminBoardCache);
  }
});

socket.on('tile:revealed', (p) => {
  lastTile = { ci:p.catIndex, ii:p.itemIndex };
  // kein Blocking-Alert nötig
});

// Sound + Live-Refresh der Antwortenzeile (ohne auf kompletten State zu warten)
socket.on('answer:revealed', (p) => {
  document.getElementById('sfxCorrect').play().catch(()=>{});
  if (adminBoardCache && lastTile && lastTile.ci===p.catIndex && lastTile.ii===p.itemIndex) {
    const it = adminBoardCache.categories?.[p.catIndex]?.items?.[p.itemIndex];
    if (it && it.answers?.[p.index]) {
      it.answers[p.index].revealed = true;
      it.answers[p.index].byTeam   = p.byTeam || null;
      renderAnswersAdmin(lastTile.ci, lastTile.ii, adminBoardCache);
    }
  }
});

socket.on('guess:wrong', () => {
  document.getElementById('sfxWrong').play().catch(()=>{});
});

socket.on('chat:spy', (m) => {
  const row = el('div', {class:'player ' + (m.from.team==='A' ? 'teamA' : 'teamB')},
    el('div', {}, `[Team ${m.from.team}] ${m.from.name}:`),
    el('div', {}, m.msg)
  );
  spyDiv.appendChild(row);
  spyDiv.scrollTop = spyDiv.scrollHeight;
});

// Optional: Bestätigung wenn die Gewinner-Animation ausgelöst wurde
socket.on('celebrate:winner', ({ team }) => {
  const who = team === 'A' ? 'Team Rot' : 'Team Blau';
  // kurzer visueller Hinweis oben
  turnBanner.style.display = 'block';
  turnBanner.textContent = `🎉 Gewinner-Animation ausgelöst für ${who}`;
  setTimeout(()=> updateTurnUI(currentTurnTeam), 3000);
});

// *** Controls ***
document.getElementById('btnDraw').onclick  = () => socket.emit('admin:drawStartTeam');
document.getElementById('btnNext').onclick  = () => socket.emit('admin:nextRound');
document.getElementById('btnReload').onclick= () => location.reload();
document.getElementById('btnAward').onclick = () => {
  const id  = document.getElementById('awId').value.trim();
  const val = parseInt(document.getElementById('awVal').value || '0', 10);
  if (!id) return alert('Spieler-ID angeben');
  socket.emit('admin:awardPoints', { playerId:id, points:val });
};
document.getElementById('btnForce').onclick = () => {
  if (!lastTile) return alert('Kein Feld aktiv');
  socket.emit('admin:forceClose', { catIndex:lastTile.ci, itemIndex:lastTile.ii });
};

// NEU: Gewinner-Team anzeigen (Konfetti/Krone bei allen)
document.getElementById('btnCelebrate').onclick = () => {
  const t = document.getElementById('winTeam').value;
  if (t !== 'A' && t !== 'B') return;
  socket.emit('admin:celebrate', { team: t });
};
</script>
</body>
</html>
