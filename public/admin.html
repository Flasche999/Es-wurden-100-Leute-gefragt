<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Â· 100 Leute gefragt</title>
  <link rel="stylesheet" href="/style.css" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    :root{
      --bg:#0b0f19; --card:#121828; --muted:#9aa4b2; --line:#22345a;
      --teamA:#ff4d6d; --teamB:#4da3ff;
      --ok:#21c55d; --warn:#f59e0b;
    }
    body{ background:#0b0f19; color:#e5e7eb; font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    .container{ max-width:1100px; margin:18px auto; padding:0 12px; }
    .header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
    .h{ font-size:20px; margin:0 0 8px; }
    .small{ font-size:12px; opacity:.9 }
    .card{ background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
           border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:12px }
    .row{ display:flex; gap:12px }
    .controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
    .btn{ background:#18223a; border:1px solid #2a3f6b; border-radius:10px; padding:8px 10px; cursor:pointer }
    .btn:hover{ filter:brightness(1.07) }
    .btn.ok{ background:#11351f; border-color:#237a45 }
    .btn.warn{ background:#3a2a11; border-color:#6b4a2a }
    .input{ background:#0f1729; color:#e5e7eb; border:1px solid #2a3f6b; border-radius:10px; padding:8px 10px; min-width:160px }

    /* Zug-Banner + Body-Akzent */
    .notice{ background:#101933; border:1px solid #2a3f6b; padding:8px 10px; border-radius:10px }
    body.turnA .notice{ border-color:rgba(255,77,109,.55) }
    body.turnB .notice{ border-color:rgba(77,163,255,.55) }

    /* Spieler/Teams */
    #players .player{
      display:flex; align-items:center; justify-content:space-between;
      padding:8px 10px; border:1px solid rgba(255,255,255,.08); border-radius:10px; margin-bottom:6px;
      background:rgba(255,255,255,.02);
    }
    .player.teamA{ box-shadow:inset 0 0 0 1px rgba(255,77,109,.2) }
    .player.teamB{ box-shadow:inset 0 0 0 1px rgba(77,163,255,.2) }
    .player.active{ border-color:#ffffff22; background:rgba(255,255,255,.035) }
    .team-pill{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #2a3f6b }
    .teamA .team-pill, .team-pill.teamA{ background:rgba(255,77,109,.15); border-color:rgba(255,77,109,.35) }
    .teamB .team-pill, .team-pill.teamB{ background:rgba(77,163,255,.15); border-color:rgba(77,163,255,.35) }

    /* Board */
    .board{ display:grid; grid-template-columns: repeat(5, 1fr); gap:8px }
    .cat{ font-weight:700; text-align:center; margin:6px 0 8px; opacity:.95 }
    .tiles{ display:grid; grid-template-rows: repeat(5, 68px); gap:8px }
    .tile{
      display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(255,255,255,.08); border-radius:12px;
      background:linear-gradient(180deg,#12203a,#0e172a); font-size:18px; user-select:none;
      cursor:pointer; transition:transform .05s ease, filter .15s ease;
    }
    .tile:hover{ transform:translateY(-1px); filter:brightness(1.05) }
    .tile.used{ background:#0d1424; border-style:dashed; color:#9aa4b2; cursor:not-allowed; filter:saturate(.7) opacity(.85) }

    /* Antwortenliste im Admin */
    .answer-row{
      display:flex; align-items:center; justify-content:space-between;
      padding:8px 10px; border:1px solid rgba(255,255,255,.08); border-radius:10px; margin:6px 0;
      background:rgba(255,255,255,.02);
    }
    .answer-row.revealed{ background:rgba(33,197,93,.08); border-color:rgba(33,197,93,.35) }

    /* Spy-Chat */
    #spy .player{ margin-bottom:6px }

    /* ===== Winner-Animation (Konfetti + Krone) ===== */
    #celebrateWrap{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      pointer-events:none; z-index:9999;
    }
    #celebrateWrap.show{ display:flex; }
    #celebrateCanvas{ position:absolute; inset:0; width:100%; height:100%; }
    .crownWrap{
      position:relative; display:flex; flex-direction:column; align-items:center; gap:6px;
      background:rgba(5,7,12,.25); border:1px solid rgba(255,255,255,.12);
      padding:14px 18px; border-radius:16px; backdrop-filter:blur(4px) saturate(1.1);
      animation:popIn .5s ease-out;
    }
    .crown{ font-size:64px; line-height:1; filter:drop-shadow(0 6px 14px rgba(0,0,0,.35)); }
    .winText{ font-weight:800; letter-spacing:.3px; }
    .winA{ color:#ff4d6d; text-shadow:0 0 24px rgba(255,77,109,.45); }
    .winB{ color:#4da3ff; text-shadow:0 0 24px rgba(77,163,255,.45); }
    @keyframes popIn{
      0%{ transform:scale(.8); opacity:0; } 100%{ transform:scale(1); opacity:1; }
    }

    /* ===== Mini-Musik-Controls (Floating) ===== */
    #musicCtl{
      position:fixed; right:14px; bottom:14px; z-index:9000;
      display:flex; align-items:center; gap:8px; padding:8px 10px;
      background:rgba(10,16,32,.7); border:1px solid #22345a; border-radius:12px;
      backdrop-filter:blur(3px) saturate(1.1);
    }
    #musicCtl button{ min-width:100px }
    #bgmVol{ width:140px; accent-color:#00e0ff; }

    /* ======= NEU: Team-Strikes (Kreuze) ======= */
    .strikesWrap{
      display:grid; grid-template-columns:1fr 1fr; gap:10px;
      margin:6px 0 12px 0;
    }
    .teamStrikes{
      padding:8px; border:1px solid var(--line); border-radius:12px; background:rgba(11,15,25,.55);
    }
    .teamStrikes .label{
      font-size:12px; opacity:.85; margin-bottom:6px; display:flex; justify-content:space-between; align-items:center;
    }
    .teamStrikes.teamA .label strong{ color:var(--teamA); }
    .teamStrikes.teamB .label strong{ color:var(--teamB); }
    .strikes{
      display:flex; gap:8px; align-items:center; justify-content:center;
    }
    .strike{
      width:18px; height:18px; opacity:.35;
      border:1px solid var(--line); border-radius:6px;
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 0 0 rgba(0,0,0,0);
      transition: transform .15s ease, opacity .15s ease, border-color .15s ease, box-shadow .15s ease;
    }
    .strike svg{ width:14px; height:14px; opacity:0; }
    .teamStrikes.teamA .strike.active{
      opacity:1; border-color: rgba(255,77,109,.6);
      box-shadow: 0 0 14px rgba(255,77,109,.35);
      transform: translateY(-1px);
    }
    .teamStrikes.teamB .strike.active{
      opacity:1; border-color: rgba(77,163,255,.6);
      box-shadow: 0 0 14px rgba(77,163,255,.35);
      transform: translateY(-1px);
    }
    .strike.active svg{ opacity:1; }

    /* ======= NEU: Admin-Strike-Controls & Runden-Overlay ======= */
    .strikeCtrls{ display:flex; gap:6px; flex-wrap:wrap; margin-top:8px }
    .strikeCtrls .btn{ padding:6px 8px }
    #roundOverlay{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.5); z-index:10000;
    }
    #roundOverlay.show{ display:flex; }
    .roundCard{
      width:min(800px, 92vw);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:14px;
      box-shadow:0 18px 60px rgba(0,0,0,.45);
    }
    .roundTable{ width:100%; border-collapse:collapse; font-size:14px; margin-top:8px }
    .roundTable th, .roundTable td{ border:1px solid #22345a; padding:6px 8px; text-align:left }
    .kbd{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
          border:1px solid #2a3f6b; padding:2px 6px; border-radius:6px; background:#0f1729; font-size:12px }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1 class="h">Admin-Panel <span class="small">(alle Antworten sichtbar)</span></h1>
    <div class="controls">
      <button class="btn" id="btnDraw">Startteam auslosen</button>
      <button class="btn" id="btnNext">NÃ¤chste Runde</button>

      <!-- Gewinner-Anzeige (Konfetti/Krone bei allen Clients) -->
      <select class="input" id="winTeam" style="min-width:auto">
        <option value="A">Gewinner: Team Rot (A)</option>
        <option value="B">Gewinner: Team Blau (B)</option>
      </select>
      <button class="btn ok" id="btnCelebrate">Gewinner-Team anzeigen</button>

      <button class="btn warn" id="btnReload">Fragen neu laden</button>

      <!-- NEU: Runden-Info Ã¶ffnen -->
      <button class="btn" id="btnRoundInfo" title="Ãœbersicht & Kopieren">Runden-Info</button>
    </div>
  </div>

  <!-- Zug-Banner -->
  <div id="turnBanner" class="notice" style="display:none; margin-bottom:12px;">â€”</div>

  <div class="row">
    <!-- Linke Spalte: Spieler & Spy-Chat -->
    <div class="card" style="flex:2">
      <h2 class="h">Spieler & Teams</h2>

      <!-- NEU: Sichtbare Kreuze (Strikes) pro Team -->
      <div class="strikesWrap">
        <div class="teamStrikes teamA">
          <div class="label">
            <strong>Team Rot</strong>
            <span>Fehler: <span id="txtA">0/3</span></span>
          </div>
          <div class="strikes" id="strikes-A">
            <div class="strike"><svg viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg></div>
            <div class="strike"><svg viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg></div>
            <div class="strike"><svg viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg></div>
          </div>
          <!-- NEU: Admin-Controls Team A -->
          <div class="strikeCtrls">
            <button class="btn" id="aMinus">â€“ Strike A</button>
            <button class="btn" id="aPlus">+ Strike A</button>
            <button class="btn warn" id="aReset">Reset A</button>
          </div>
        </div>
        <div class="teamStrikes teamB">
          <div class="label">
            <strong>Team Blau</strong>
            <span>Fehler: <span id="txtB">0/3</span></span>
          </div>
          <div class="strikes" id="strikes-B">
            <div class="strike"><svg viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg></div>
            <div class="strike"><svg viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg></div>
            <div class="strike"><svg viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg></div>
          </div>
          <!-- NEU: Admin-Controls Team B -->
          <div class="strikeCtrls">
            <button class="btn" id="bMinus">â€“ Strike B</button>
            <button class="btn" id="bPlus">+ Strike B</button>
            <button class="btn warn" id="bReset">Reset B</button>
          </div>
        </div>
      </div>

      <!-- NEU: Globaler Reset fÃ¼r beide Teams -->
      <div class="controls" style="margin:6px 0 10px">
        <button class="btn warn" id="resetBoth">Alle Strikes zurÃ¼cksetzen</button>
      </div>

      <div id="players" class="list"></div>

      <h2 class="h" style="margin-top:10px">Team-Chats (live)</h2>
      <div class="small">Admin sieht beide Team-Chats in Echtzeit</div>
      <div id="spy" class="list" style="max-height:220px; overflow:auto"></div>
    </div>

    <!-- Rechte Spalte: Brett & Antworten -->
    <div class="card" style="flex:3">
      <h2 class="h">Brett</h2>
      <div id="board" class="board"></div>

      <div id="answers" style="margin-top:12px"></div>

      <div class="controls" style="margin-top:10px">
        <input id="awId" class="input" placeholder="Spieler-ID" />
        <input id="awVal" class="input" type="number" value="10" />
        <button class="btn ok" id="btnAward">Punkte an Spieler</button>
        <button class="btn" id="btnForce">Feld schlieÃŸen</button>
      </div>
    </div>
  </div>
</div>

<!-- Audios: preload auf 'none' (Server liefert Fallback, falls MP3 fehlt) -->
<audio id="sfxCorrect" src="/sfx/correct.mp3" preload="none"></audio>
<audio id="sfxWrong"   src="/sfx/wrong.mp3"   preload="none"></audio>
<!-- NEU: Select/Lock-in-Sound bei Feldwahl -->
<audio id="sfxSelect"  src="/sfx/select.mp3"  preload="none"></audio>

<!-- NEU: Hintergrundmusik (lÃ¤uft bei allen, mit User-Geste starten) -->
<audio id="bgm" src="/music/bgm.mp3" preload="none" loop playsinline></audio>

<!-- NEU: Mini-Musik-Controls (floating) -->
<div id="musicCtl" class="card" style="padding:8px 10px;">
  <button class="btn" id="btnMusic">Musik â–¶ï¸Ž</button>
  <input id="bgmVol" type="range" min="0" max="1" step="0.01" title="LautstÃ¤rke">
</div>

<!-- NEU: Winner-Overlay (Konfetti + Krone) -->
<div id="celebrateWrap">
  <canvas id="celebrateCanvas"></canvas>
  <div class="crownWrap" id="crownWrap">
    <div class="crown">ðŸ‘‘</div>
    <div class="winText" id="winText">Team</div>
  </div>
</div>

<!-- NEU: Runden-Info Overlay -->
<div id="roundOverlay">
  <div class="roundCard">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px">
      <div>
        <div class="h" style="margin:0">Runden-Ãœbersicht</div>
        <div class="small" id="roundMeta">â€”</div>
      </div>
      <div class="controls">
        <button class="btn" id="btnCopyRound" title="In Zwischenablage kopieren">Kopieren</button>
        <button class="btn warn" id="btnCloseRound">SchlieÃŸen</button>
      </div>
    </div>
    <table class="roundTable" id="roundTable">
      <thead>
        <tr><th>#</th><th>Spieler</th><th>Team</th><th>Punkte</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="small" style="margin-top:8px">
      Shortcuts: <span class="kbd">A</span>/<span class="kbd">Shift+A</span> Strike Â± Team A Â·
      <span class="kbd">B</span>/<span class="kbd">Shift+B</span> Strike Â± Team B Â·
      <span class="kbd">W</span> Als falsch werten Â·
      <span class="kbd">Esc</span> schlieÃŸen
    </div>
  </div>
</div>

<script>
const socket = io();
socket.emit('role:admin');

let lastTile = null;           // {ci, ii}
let adminBoardCache = null;
let currentTurnTeam = null;    // 'A' | 'B' | null
let lastPlayersCache = [];     // fÃ¼r Re-Highlight

// Mini-Helper
function el(t, attrs={}, ...children){
  const e = document.createElement(t);
  Object.entries(attrs).forEach(([k,v]) => e.setAttribute(k, v));
  children.forEach(c => e.appendChild(typeof c==='string' ? document.createTextNode(c) : c));
  return e;
}

// Refs
const playersDiv = document.getElementById('players');
const boardDiv   = document.getElementById('board');
const answersDiv = document.getElementById('answers');
const spyDiv     = document.getElementById('spy');
const turnBanner = document.getElementById('turnBanner');

// ===== Hintergrundmusik =====
const bgm     = document.getElementById('bgm');
const btnMus  = document.getElementById('btnMusic');
const volSl   = document.getElementById('bgmVol');

function updateMusicBtn(){
  btnMus.textContent = bgm.paused ? 'Musik â–¶ï¸Ž' : 'Musik â¸';
}

function tryPlayBgm(){
  if (!bgm) return;
  bgm.play().then(updateMusicBtn).catch(()=>{/* Autoplay blockiert bis User-Geste */});
}

function initBgm(){
  const savedVol = parseFloat(localStorage.getItem('bgmVol') ?? '0.35');
  const vol = isFinite(savedVol) ? Math.min(1, Math.max(0, savedVol)) : 0.35;
  bgm.volume = vol;
  volSl.value = String(vol);

  updateMusicBtn();

  // Erst auf User-Geste starten (Autoplay-Policy)
  const startOnce = () => { tryPlayBgm(); document.removeEventListener('pointerdown', startOnce); };
  document.addEventListener('pointerdown', startOnce, { once:true });

  // Falls Tab wieder fokussiert â†’ weiter spielen
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible' && !bgm.paused) tryPlayBgm();
  });
}

btnMus.onclick = () => {
  if (bgm.paused){ tryPlayBgm(); }
  else { bgm.pause(); updateMusicBtn(); }
};
volSl.oninput = (e) => {
  const v = parseFloat(e.target.value || '0.35');
  bgm.volume = v;
  localStorage.setItem('bgmVol', String(v));
};
initBgm();

// ===== Winner-Konfetti & Krone =====
const celebWrap = document.getElementById('celebrateWrap');
const canvas    = document.getElementById('celebrateCanvas');
const ctx       = canvas.getContext('2d');
const crownWrap = document.getElementById('crownWrap');
const winText   = document.getElementById('winText');

function resizeCanvas(){
  canvas.width  = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);

function confettiBurst(durationMs=4500, team='A'){
  resizeCanvas();
  celebWrap.classList.add('show');

  // Text/Farbe
  if (team === 'A'){
    winText.textContent = 'Team Rot gewinnt!';
    winText.className = 'winText winA';
  } else {
    winText.textContent = 'Team Blau gewinnt!';
    winText.className = 'winText winB';
  }

  // simple particles
  const colorsA = ['#ff4d6d','#ffd166','#ffffff'];
  const colorsB = ['#4da3ff','#7ed957','#ffffff'];
  const colors  = team==='A' ? colorsA : colorsB;

  const N = 180;
  const P = [];
  for (let i=0;i<N;i++){
    P.push({
      x: Math.random()*canvas.width,
      y: -20 - Math.random()*canvas.height*0.6,
      r: 4 + Math.random()*4,
      c: colors[i % colors.length],
      vx: -1 + Math.random()*2,
      vy: 2 + Math.random()*3,
      rot: Math.random()*Math.PI,
      vr: -0.2 + Math.random()*0.4
    });
  }

  let rafId;
  const t0 = performance.now();
  function tick(t){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(const p of P){
      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.vr;
      p.vy += 0.02; // gravity
      // draw rectangle piece
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      ctx.fillStyle = p.c;
      ctx.fillRect(-p.r, -p.r*0.6, p.r*2, p.r*1.2);
      ctx.restore();
      if (p.y > canvas.height + 30) {
        p.y = -20;
        p.x = Math.random()*canvas.width;
        p.vy = 2 + Math.random()*3;
      }
    }
    if (t - t0 < durationMs){
      rafId = requestAnimationFrame(tick);
    } else {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      celebWrap.classList.remove('show');
      cancelAnimationFrame(rafId);
    }
  }
  rafId = requestAnimationFrame(tick);
}

// ===== NEU: Zug-UI aktualisieren (Banner + Body-Klasse + Player-Highlight)
function updateTurnUI(team){
  currentTurnTeam = (team === 'A' || team === 'B') ? team : null;

  document.body.classList.remove('turnA','turnB');
  if (currentTurnTeam){
    document.body.classList.add(currentTurnTeam === 'A' ? 'turnA' : 'turnB');
    turnBanner.style.display = 'block';
    turnBanner.textContent = `Am Zug: ${currentTurnTeam === 'A' ? 'Team Rot' : 'Team Blau'}`;
  } else {
    turnBanner.style.display = 'none';
  }

  // Spieler-Re-Render, um aktives Team zu markieren
  if (lastPlayersCache?.length) renderPlayers(lastPlayersCache);
}

// Spieler rendern (markiert Team am Zug)
function renderPlayers(players){
  lastPlayersCache = players || [];
  playersDiv.innerHTML = '';
  lastPlayersCache.forEach(p => {
    const cls = ['player', (p.team==='A' ? 'teamA' : 'teamB')];
    if (currentTurnTeam && p.team === currentTurnTeam) cls.push('active');
    const row = el('div', { class: cls.join(' ') },
      el('div', {}, `${p.name} Â· Team ${p.team}`,
        ...(currentTurnTeam && p.team===currentTurnTeam ? [el('span',{class:'team-pill', style:'margin-left:8px'}, 'Am Zug')] : [])
      ),
      el('div', {}, `${p.score} Punkte`)
    );
    row.onclick = () => { document.getElementById('awId').value = p.id; };
    playersDiv.appendChild(row);
  });
}

// ======= NEU: Strikes-Rendering (Admin) =======
function renderStrikes(team, count){
  const wrap = document.getElementById(team === 'A' ? 'strikes-A' : 'strikes-B');
  const txt  = document.getElementById(team === 'A' ? 'txtA' : 'txtB');
  if (!wrap || !txt) return;
  const items = wrap.querySelectorAll('.strike');
  items.forEach((el, idx) => {
    if (idx < count) el.classList.add('active');
    else el.classList.remove('active');
  });
  txt.textContent = `${count}/3`;
}
socket.on('strikes:update', ({ A=0, B=0 }) => {
  renderStrikes('A', Math.max(0, Math.min(3, A)));
  renderStrikes('B', Math.max(0, Math.min(3, B)));
});

// Brett rendern (zeigt 1..5 als Label)
function renderBoard(board){
  boardDiv.innerHTML = '';
  board.categories.forEach((cat, ci) => {
    const col = el('div', {});
    col.appendChild(el('div', {class:'cat'}, cat.name));
    const tiles = el('div', {class:'tiles'});
    cat.items.forEach((it, ii) => {
      const used = it.revealed || it.answered;
      const d = el('div', { class: 'tile' + (used ? ' used' : '') }, String(it.points));
      d.onclick = () => {
        if (used) return;
        lastTile = { ci:ci, ii:ii };
        socket.emit('player:pickTile', { catIndex:ci, itemIndex:ii }); // Admin kann Feld Ã¶ffnen
      };
      tiles.appendChild(d);
    });
    col.appendChild(tiles);
    boardDiv.appendChild(col);
  });
}

// Admin-Ansicht Antworten inkl. Meta, Fehlversuche, Badges, Reveal-All + Als-falsch-werten
function renderAnswersAdmin(ci, ii, admBoard){
  adminBoardCache = admBoard;
  answersDiv.innerHTML = '';
  const item = admBoard?.categories?.[ci]?.items?.[ii];
  if (!item) return;

  // Kopfzeile mit Frage
  answersDiv.appendChild(el('div', {class:'small'}, `Feld ${item.points} Â· Frage: ${item.q}`));

  // Meta-Zeile: Am Zug, Original, Fehlversuche A/B, Steal-Status
  const stealInfo = item.meta.stealActive
    ? ` Â· Abstauber: Team ${item.meta.stealTeam ?? 'â€“'} (1 Chance)`
    : '';
  const meta = el('div', {class:'player'},
    el('div', {},
      el('span', {class: 'team-pill ' + (item.meta.turnTeam==='A' ? 'teamA' : 'teamB')},
        `Am Zug: Team ${item.meta.turnTeam ?? 'â€“'}`
      ),
      el('span', {class: 'team-pill', style: 'margin-left:8px'},
        `Original: Team ${item.meta.originalTeam ?? 'â€“'}`
      ),
      el('span', {class: 'team-pill', style: 'margin-left:8px'},
        item.meta.stealActive ? 'Abstauber aktiv' : 'Normalphase'
      ),
      document.createTextNode(stealInfo)
    ),
    el('div', {}, `Fehlversuche A: ${item.meta.wrongA ?? 0}/3 Â· B: ${item.meta.wrongB ?? 0}/3`)
  );
  answersDiv.appendChild(meta);

  // Antwortenliste (klickbar zum manuellen Reveal)
  item.answers.forEach((a, idx) => {
    const row = el('div', {class:'answer-row ' + (a.revealed ? 'revealed' : '')});
    const left  = el('div', {}, `${idx+1}. ${a.text}`);
    const right = el('div', {}, `${a.percent}%`);

    if (a.byTeam) {
      right.appendChild(
        el('span', {class: 'team-pill ' + (a.byTeam==='A' ? 'teamA' : 'teamB'), style:'margin-left:8px'}, `Team ${a.byTeam}`)
      );
    }

    row.appendChild(left);
    row.appendChild(right);

    if (!a.revealed) {
      row.style.cursor = 'pointer';
      row.title = 'Antwort manuell aufdecken';
      row.onclick = () => socket.emit('admin:revealAnswer', { catIndex:ci, itemIndex:ii, index:idx });
    }

    answersDiv.appendChild(row);
  });

  // Footer-Controls
  const footer = el('div', {class:'controls', style:'margin-top:10px'});

  // Falschantwort zÃ¤hlen (Team am Zug)
  const wrongBtn = el('button', {class:'btn warn', id:'btnMarkWrong'}, 'Als falsch werten (Team am Zug)');
  wrongBtn.onclick = () => socket.emit('admin:markWrong', { catIndex:ci, itemIndex:ii });

  // Alle verbleibenden anzeigen
  const revealAllBtn = el('button', {class:'btn', id:'btnRevealAll'}, 'Alle verbleibenden anzeigen');
  revealAllBtn.onclick = () => {
    item.answers.forEach((a, idx) => {
      if (!a.revealed) socket.emit('admin:revealAnswer', { catIndex:ci, itemIndex:ii, index:idx });
    });
  };

  footer.appendChild(wrongBtn);
  footer.appendChild(revealAllBtn);
  answersDiv.appendChild(footer);
}

// *** Events ***

socket.on('state:update', (data) => {
  renderPlayers(data.players);
  renderBoard(data.board);
});

socket.on('state:admin', (data) => {
  renderPlayers(data.players);
  renderBoard(data.board);
  if (lastTile) renderAnswersAdmin(lastTile.ci, lastTile.ii, data.board);
});

// Globaler Start-Zug & Zugwechsel â†’ Admin-UI markieren
socket.on('turn:global', (p) => {
  updateTurnUI(p.team);
});
socket.on('turn:changed', (p) => {
  updateTurnUI(p.turnTeam || p.team);
  if (lastTile && adminBoardCache) {
    renderAnswersAdmin(lastTile.ci, lastTile.ii, adminBoardCache);
  }
});

// NEU: Select/Lock-in-Sound sobald ein Feld gewÃ¤hlt/gestartet wurde
socket.on('tile:revealed', (p) => {
  const sel = document.getElementById('sfxSelect');
  if (sel) sel.play().catch(()=>{});
  lastTile = { ci:p.catIndex, ii:p.itemIndex };
});

// Sound + Live-Refresh der Antwortenzeile (ohne auf kompletten State zu warten)
socket.on('answer:revealed', (p) => {
  const s = document.getElementById('sfxCorrect');
  if (s) s.play().catch(()=>{});
  if (adminBoardCache && lastTile && lastTile.ci===p.catIndex && lastTile.ii===p.itemIndex) {
    const it = adminBoardCache.categories?.[p.catIndex]?.items?.[p.itemIndex];
    if (it && it.answers?.[p.index]) {
      it.answers[p.index].revealed = true;
      it.answers[p.index].byTeam   = p.byTeam || null;
      renderAnswersAdmin(lastTile.ci, lastTile.ii, adminBoardCache);
    }
  }
});

// NEU: Wrong-Sound wird NACH Strike-Update vom Server via 'guess:wrong' getriggert
socket.on('guess:wrong', () => {
  const s = document.getElementById('sfxWrong');
  if (s) s.play().catch(()=>{});
});

socket.on('chat:spy', (m) => {
  const row = el('div', {class:'player ' + (m.from.team==='A' ? 'teamA' : 'teamB')},
    el('div', {}, `[Team ${m.from.team}] ${m.from.name}:`),
    el('div', {}, m.msg)
  );
  spyDiv.appendChild(row);
  spyDiv.scrollTop = spyDiv.scrollHeight;
});

// Gewinner-Animation bei allen Clients
socket.on('celebrate:winner', ({ team }) => {
  const who = team === 'A' ? 'Team Rot' : 'Team Blau';
  turnBanner.style.display = 'block';
  turnBanner.textContent = `ðŸŽ‰ Gewinner: ${who}`;
  confettiBurst(5200, team);
  setTimeout(()=> updateTurnUI(currentTurnTeam), 5400);
});

// *** Controls (bestehend) ***
document.getElementById('btnDraw').onclick  = () => socket.emit('admin:drawStartTeam');
document.getElementById('btnNext').onclick  = () => socket.emit('admin:nextRound');
document.getElementById('btnReload').onclick= () => location.reload();
document.getElementById('btnAward').onclick = () => {
  const id  = document.getElementById('awId').value.trim();
  const val = parseInt(document.getElementById('awVal').value || '0', 10);
  if (!id) return alert('Spieler-ID angeben');
  socket.emit('admin:awardPoints', { playerId:id, points:val });
};
document.getElementById('btnForce').onclick = () => {
  if (!lastTile) return alert('Kein Feld aktiv');
  socket.emit('admin:forceClose', { catIndex:lastTile.ci, itemIndex:lastTile.ii });
};

// Gewinner-Team anzeigen (Konfetti/Krone bei allen)
document.getElementById('btnCelebrate').onclick = () => {
  const t = document.getElementById('winTeam').value;
  if (t !== 'A' && t !== 'B') return;
  socket.emit('admin:celebrate', { team: t });
};

// ====== NEU: Strike-Controls verdrahten ======
const aMinus = document.getElementById('aMinus');
const aPlus  = document.getElementById('aPlus');
const aReset = document.getElementById('aReset');
const bMinus = document.getElementById('bMinus');
const bPlus  = document.getElementById('bPlus');
const bReset = document.getElementById('bReset');
const resetBoth = document.getElementById('resetBoth');

if (aMinus) aMinus.onclick = () => socket.emit('admin:adjustStrikes', { team:'A', delta:-1 });
if (aPlus)  aPlus.onclick  = () => socket.emit('admin:adjustStrikes', { team:'A', delta:+1 });
if (aReset) aReset.onclick = () => socket.emit('admin:resetStrikes',   { team:'A' });
if (bMinus) bMinus.onclick = () => socket.emit('admin:adjustStrikes', { team:'B', delta:-1 });
if (bPlus)  bPlus.onclick  = () => socket.emit('admin:adjustStrikes', { team:'B', delta:+1 });
if (bReset) bReset.onclick = () => socket.emit('admin:resetStrikes',   { team:'B' });
if (resetBoth) resetBoth.onclick = () => socket.emit('admin:resetStrikes', { team:'ALL' });

// ====== NEU: Tastatur-Shortcuts ======
document.addEventListener('keydown', (e)=>{
  // ESC: Overlay schlieÃŸen
  if (e.key === 'Escape'){
    hideRoundOverlay();
    return;
  }
  if (e.key.toLowerCase() === 'a'){
    if (e.shiftKey) socket.emit('admin:adjustStrikes', { team:'A', delta:-1 });
    else            socket.emit('admin:adjustStrikes', { team:'A', delta:+1 });
  }
  if (e.key.toLowerCase() === 'b'){
    if (e.shiftKey) socket.emit('admin:adjustStrikes', { team:'B', delta:-1 });
    else            socket.emit('admin:adjustStrikes', { team:'B', delta:+1 });
  }
  if (e.key.toLowerCase() === 'w'){
    // Als falsch werten (Team am Zug)
    if (lastTile) socket.emit('admin:markWrong', { catIndex:lastTile.ci, itemIndex:lastTile.ii });
  }
});

// ====== NEU: Runden-Overlay (Spielstand / Kopieren) ======
const roundOverlay = document.getElementById('roundOverlay');
const btnRoundInfo = document.getElementById('btnRoundInfo');
const btnCloseRound= document.getElementById('btnCloseRound');
const btnCopyRound = document.getElementById('btnCopyRound');
const roundTable   = document.querySelector('#roundTable tbody');
const roundMeta    = document.getElementById('roundMeta');

function showRoundOverlay(){
  // Meta
  const metaTxt = `Am Zug: ${currentTurnTeam ? (currentTurnTeam==='A'?'Team Rot':'Team Blau') : 'â€”'}`;
  roundMeta.textContent = metaTxt;

  // Tabelle
  roundTable.innerHTML = '';
  const rows = [...lastPlayersCache]
    .sort((a,b)=> b.score - a.score)
    .map((p,i)=> ({i:i+1, name:p.name, team:p.team, score:p.score}));
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.i}</td><td>${r.name}</td><td>${r.team}</td><td>${r.score}</td>`;
    roundTable.appendChild(tr);
  });

  roundOverlay.classList.add('show');
}
function hideRoundOverlay(){ roundOverlay.classList.remove('show'); }

if (btnRoundInfo) btnRoundInfo.onclick = showRoundOverlay;
if (btnCloseRound) btnCloseRound.onclick = hideRoundOverlay;
if (roundOverlay) roundOverlay.addEventListener('click', (e)=>{ if (e.target === roundOverlay) hideRoundOverlay(); });

if (btnCopyRound){
  btnCopyRound.onclick = async ()=>{
    const rows = [...lastPlayersCache]
      .sort((a,b)=> b.score - a.score)
      .map((p,i)=> `${i+1}. ${p.name} (Team ${p.team}) â€“ ${p.score} Punkte`);
    const txt = [
      'Runden-Ãœbersicht',
      `Am Zug: ${currentTurnTeam ? (currentTurnTeam==='A'?'Team Rot':'Team Blau') : 'â€”'}`,
      ...rows
    ].join('\n');
    try{
      await navigator.clipboard.writeText(txt);
      btnCopyRound.textContent = 'Kopiert âœ“';
      setTimeout(()=> btnCopyRound.textContent = 'Kopieren', 1200);
    }catch(_){
      alert('Kopieren nicht mÃ¶glich.');
    }
  };
}
</script>
</body>
</html>
