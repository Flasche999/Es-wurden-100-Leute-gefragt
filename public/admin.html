<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin · 100 Leute gefragt</title>
  <link rel="stylesheet" href="/style.css" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    /* ===== Winner-Animation (Konfetti + Krone) ===== */
    #celebrateWrap{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      pointer-events:none; z-index:9999;
    }
    #celebrateWrap.show{ display:flex; }
    #celebrateCanvas{ position:absolute; inset:0; width:100%; height:100%; }
    .crownWrap{
      position:relative; display:flex; flex-direction:column; align-items:center; gap:6px;
      background:rgba(5,7,12,.25); border:1px solid rgba(255,255,255,.12);
      padding:14px 18px; border-radius:16px; backdrop-filter:blur(4px) saturate(1.1);
      animation:popIn .5s ease-out;
    }
    .crown{ font-size:64px; line-height:1; filter:drop-shadow(0 6px 14px rgba(0,0,0,.35)); }
    .winText{ font-weight:800; letter-spacing:.3px; }
    .winA{ color:#ff4d6d; text-shadow:0 0 24px rgba(255,77,109,.45); }
    .winB{ color:#4da3ff; text-shadow:0 0 24px rgba(77,163,255,.45); }
    @keyframes popIn{
      0%{ transform:scale(.8); opacity:0; } 100%{ transform:scale(1); opacity:1; }
    }

    /* ===== Mini-Musik-Controls (Floating) ===== */
    #musicCtl{
      position:fixed; right:14px; bottom:14px; z-index:9000;
      display:flex; align-items:center; gap:8px; padding:8px 10px;
      background:rgba(10,16,32,.7); border:1px solid #22345a; border-radius:12px;
      backdrop-filter:blur(3px) saturate(1.1);
    }
    #musicCtl button{ min-width:100px }
    #bgmVol{ width:140px; accent-color:#00e0ff; }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1 class="h">Admin-Panel <span class="small">(alle Antworten sichtbar)</span></h1>
    <div class="controls">
      <button class="btn" id="btnDraw">Startteam auslosen</button>
      <button class="btn" id="btnNext">Nächste Runde</button>

      <!-- Gewinner-Anzeige (Konfetti/Krone bei allen Clients) -->
      <select class="input" id="winTeam" style="min-width:auto">
        <option value="A">Gewinner: Team Rot (A)</option>
        <option value="B">Gewinner: Team Blau (B)</option>
      </select>
      <button class="btn ok" id="btnCelebrate">Gewinner-Team anzeigen</button>

      <button class="btn warn" id="btnReload">Fragen neu laden</button>
    </div>
  </div>

  <!-- Zug-Banner -->
  <div id="turnBanner" class="notice" style="display:none; margin-bottom:12px;">—</div>

  <div class="row">
    <!-- Linke Spalte: Spieler & Spy-Chat -->
    <div class="card" style="flex:2">
      <h2 class="h">Spieler & Teams</h2>
      <div id="players" class="list"></div>

      <h2 class="h" style="margin-top:10px">Team-Chats (live)</h2>
      <div class="small">Admin sieht beide Team-Chats in Echtzeit</div>
      <div id="spy" class="list" style="max-height:220px; overflow:auto"></div>
    </div>

    <!-- Rechte Spalte: Brett & Antworten -->
    <div class="card" style="flex:3">
      <h2 class="h">Brett</h2>
      <div id="board" class="board"></div>

      <div id="answers" style="margin-top:12px"></div>

      <div class="controls" style="margin-top:10px">
        <input id="awId" class="input" placeholder="Spieler-ID" />
        <input id="awVal" class="input" type="number" value="10" />
        <button class="btn ok" id="btnAward">Punkte an Spieler</button>
        <button class="btn" id="btnForce">Feld schließen</button>
      </div>
    </div>
  </div>
</div>

<!-- Audios: preload auf 'none' (Server liefert Fallback, falls MP3 fehlt) -->
<audio id="sfxCorrect" src="/sfx/correct.mp3" preload="none"></audio>
<audio id="sfxWrong"   src="/sfx/wrong.mp3"   preload="none"></audio>
<!-- NEU: Select/Lock-in-Sound bei Feldwahl -->
<audio id="sfxSelect"  src="/sfx/select.mp3"  preload="none"></audio>

<!-- NEU: Hintergrundmusik (läuft bei allen, mit User-Geste starten) -->
<audio id="bgm" src="/music/bgm.mp3" preload="none" loop playsinline></audio>

<!-- NEU: Mini-Musik-Controls (floating) -->
<div id="musicCtl" class="card" style="padding:8px 10px;">
  <button class="btn" id="btnMusic">Musik ▶︎</button>
  <input id="bgmVol" type="range" min="0" max="1" step="0.01" title="Lautstärke">
</div>

<!-- NEU: Winner-Overlay (Konfetti + Krone) -->
<div id="celebrateWrap">
  <canvas id="celebrateCanvas"></canvas>
  <div class="crownWrap" id="crownWrap">
    <div class="crown">👑</div>
    <div class="winText" id="winText">Team</div>
  </div>
</div>

<script>
const socket = io();
socket.emit('role:admin');

let lastTile = null;           // {ci, ii}
let adminBoardCache = null;
let currentTurnTeam = null;    // 'A' | 'B' | null
let lastPlayersCache = [];     // für Re-Highlight

// Mini-Helper
function el(t, attrs={}, ...children){
  const e = document.createElement(t);
  Object.entries(attrs).forEach(([k,v]) => e.setAttribute(k, v));
  children.forEach(c => e.appendChild(typeof c==='string' ? document.createTextNode(c) : c));
  return e;
}

// Refs
const playersDiv = document.getElementById('players');
const boardDiv   = document.getElementById('board');
const answersDiv = document.getElementById('answers');
const spyDiv     = document.getElementById('spy');
const turnBanner = document.getElementById('turnBanner');

// ===== Hintergrundmusik =====
const bgm     = document.getElementById('bgm');
const btnMus  = document.getElementById('btnMusic');
const volSl   = document.getElementById('bgmVol');

function updateMusicBtn(){
  btnMus.textContent = bgm.paused ? 'Musik ▶︎' : 'Musik ⏸';
}

function tryPlayBgm(){
  if (!bgm) return;
  bgm.play().then(updateMusicBtn).catch(()=>{/* Autoplay blockiert bis User-Geste */});
}

function initBgm(){
  const savedVol = parseFloat(localStorage.getItem('bgmVol') ?? '0.35');
  const vol = isFinite(savedVol) ? Math.min(1, Math.max(0, savedVol)) : 0.35;
  bgm.volume = vol;
  volSl.value = String(vol);

  updateMusicBtn();

  // Erst auf User-Geste starten (Autoplay-Policy)
  const startOnce = () => { tryPlayBgm(); document.removeEventListener('pointerdown', startOnce); };
  document.addEventListener('pointerdown', startOnce, { once:true });

  // Falls Tab wieder fokussiert → weiter spielen
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible' && !bgm.paused) tryPlayBgm();
  });
}

btnMus.onclick = () => {
  if (bgm.paused){ tryPlayBgm(); }
  else { bgm.pause(); updateMusicBtn(); }
};
volSl.oninput = (e) => {
  const v = parseFloat(e.target.value || '0.35');
  bgm.volume = v;
  localStorage.setItem('bgmVol', String(v));
};
initBgm();

// ===== Winner-Konfetti & Krone =====
const celebWrap = document.getElementById('celebrateWrap');
const canvas    = document.getElementById('celebrateCanvas');
const ctx       = canvas.getContext('2d');
const crownWrap = document.getElementById('crownWrap');
const winText   = document.getElementById('winText');

function resizeCanvas(){
  canvas.width  = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);

function confettiBurst(durationMs=4500, team='A'){
  resizeCanvas();
  celebWrap.classList.add('show');

  // Text/Farbe
  if (team === 'A'){
    winText.textContent = 'Team Rot gewinnt!';
    winText.className = 'winText winA';
  } else {
    winText.textContent = 'Team Blau gewinnt!';
    winText.className = 'winText winB';
  }

  // simple particles
  const colorsA = ['#ff4d6d','#ffd166','#ffffff'];
  const colorsB = ['#4da3ff','#7ed957','#ffffff'];
  const colors  = team==='A' ? colorsA : colorsB;

  const N = 180;
  const P = [];
  for (let i=0;i<N;i++){
    P.push({
      x: Math.random()*canvas.width,
      y: -20 - Math.random()*canvas.height*0.6,
      r: 4 + Math.random()*4,
      c: colors[i % colors.length],
      vx: -1 + Math.random()*2,
      vy: 2 + Math.random()*3,
      rot: Math.random()*Math.PI,
      vr: -0.2 + Math.random()*0.4
    });
  }

  let rafId;
  const t0 = performance.now();
  function tick(t){
    const dt = 16/1000;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(const p of P){
      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.vr;
      p.vy += 0.02; // gravity
      // draw rectangle piece
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      ctx.fillStyle = p.c;
      ctx.fillRect(-p.r, -p.r*0.6, p.r*2, p.r*1.2);
      ctx.restore();
      if (p.y > canvas.height + 30) {
        p.y = -20;
        p.x = Math.random()*canvas.width;
        p.vy = 2 + Math.random()*3;
      }
    }
    if (t - t0 < durationMs){
      rafId = requestAnimationFrame(tick);
    } else {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      celebWrap.classList.remove('show');
      cancelAnimationFrame(rafId);
    }
  }
  rafId = requestAnimationFrame(tick);
}

// ===== NEU: Zug-UI aktualisieren (Banner + Body-Klasse + Player-Highlight)
function updateTurnUI(team){
  currentTurnTeam = (team === 'A' || team === 'B') ? team : null;

  document.body.classList.remove('turnA','turnB');
  if (currentTurnTeam){
    document.body.classList.add(currentTurnTeam === 'A' ? 'turnA' : 'turnB');
    turnBanner.style.display = 'block';
    turnBanner.textContent = `Am Zug: ${currentTurnTeam === 'A' ? 'Team Rot' : 'Team Blau'}`;
  } else {
    turnBanner.style.display = 'none';
  }

  // Spieler-Re-Render, um aktives Team zu markieren
  if (lastPlayersCache?.length) renderPlayers(lastPlayersCache);
}

// Spieler rendern (markiert Team am Zug)
function renderPlayers(players){
  lastPlayersCache = players || [];
  playersDiv.innerHTML = '';
  lastPlayersCache.forEach(p => {
    const cls = ['player', (p.team==='A' ? 'teamA' : 'teamB')];
    if (currentTurnTeam && p.team === currentTurnTeam) cls.push('active');
    const row = el('div', { class: cls.join(' ') },
      el('div', {}, `${p.name} · Team ${p.team}`,
        ...(currentTurnTeam && p.team===currentTurnTeam ? [el('span',{class:'team-pill', style:'margin-left:8px'}, 'Am Zug')] : [])
      ),
      el('div', {}, `${p.score} Punkte`)
    );
    row.onclick = () => { document.getElementById('awId').value = p.id; };
    playersDiv.appendChild(row);
  });
}

// Brett rendern (zeigt 1..5 als Label)
function renderBoard(board){
  boardDiv.innerHTML = '';
  board.categories.forEach((cat, ci) => {
    const col = el('div', {});
    col.appendChild(el('div', {class:'cat'}, cat.name));
    const tiles = el('div', {class:'tiles'});
    cat.items.forEach((it, ii) => {
      const used = it.revealed || it.answered;
      const d = el('div', { class: 'tile' + (used ? ' used' : '') }, String(it.points));
      d.onclick = () => {
        if (used) return;
        lastTile = { ci:ci, ii:ii };
        socket.emit('player:pickTile', { catIndex:ci, itemIndex:ii }); // Admin kann Feld öffnen
      };
      tiles.appendChild(d);
    });
    col.appendChild(tiles);
    boardDiv.appendChild(col);
  });
}

// Admin-Ansicht Antworten inkl. Meta, Fehlversuche, Badges, Reveal-All + Als-falsch-werten
function renderAnswersAdmin(ci, ii, admBoard){
  adminBoardCache = admBoard;
  answersDiv.innerHTML = '';
  const item = admBoard?.categories?.[ci]?.items?.[ii];
  if (!item) return;

  // Kopfzeile mit Frage
  answersDiv.appendChild(el('div', {class:'small'}, `Feld ${item.points} · Frage: ${item.q}`));

  // Meta-Zeile: Am Zug, Original, Fehlversuche A/B, Steal-Status
  const stealInfo = item.meta.stealActive
    ? ` · Abstauber: Team ${item.meta.stealTeam ?? '–'} (1 Chance)`
    : '';
  const meta = el('div', {class:'player'},
    el('div', {},
      el('span', {class: 'team-pill ' + (item.meta.turnTeam==='A' ? 'teamA' : 'teamB')},
        `Am Zug: Team ${item.meta.turnTeam ?? '–'}`
      ),
      el('span', {class: 'team-pill', style: 'margin-left:8px'},
        `Original: Team ${item.meta.originalTeam ?? '–'}`
      ),
      el('span', {class: 'team-pill', style: 'margin-left:8px'},
        item.meta.stealActive ? 'Abstauber aktiv' : 'Normalphase'
      ),
      document.createTextNode(stealInfo)
    ),
    el('div', {}, `Fehlversuche A: ${item.meta.wrongA ?? 0}/3 · B: ${item.meta.wrongB ?? 0}/3`)
  );
  answersDiv.appendChild(meta);

  // Antwortenliste (klickbar zum manuellen Reveal)
  item.answers.forEach((a, idx) => {
    const row = el('div', {class:'answer-row ' + (a.revealed ? 'revealed' : '')});
    const left  = el('div', {}, `${idx+1}. ${a.text}`);
    const right = el('div', {}, `${a.percent}%`);

    if (a.byTeam) {
      right.appendChild(
        el('span', {class: 'team-pill ' + (a.byTeam==='A' ? 'teamA' : 'teamB'), style:'margin-left:8px'}, `Team ${a.byTeam}`)
      );
    }

    row.appendChild(left);
    row.appendChild(right);

    if (!a.revealed) {
      row.style.cursor = 'pointer';
      row.title = 'Antwort manuell aufdecken';
      row.onclick = () => socket.emit('admin:revealAnswer', { catIndex:ci, itemIndex:ii, index:idx });
    }

    answersDiv.appendChild(row);
  });

  // Footer-Controls
  const footer = el('div', {class:'controls', style:'margin-top:10px'});

  // Falschantwort zählen (Team am Zug)
  const wrongBtn = el('button', {class:'btn warn', id:'btnMarkWrong'}, 'Als falsch werten (Team am Zug)');
  wrongBtn.onclick = () => socket.emit('admin:markWrong', { catIndex:ci, itemIndex:ii });

  // Alle verbleibenden anzeigen
  const revealAllBtn = el('button', {class:'btn', id:'btnRevealAll'}, 'Alle verbleibenden anzeigen');
  revealAllBtn.onclick = () => {
    item.answers.forEach((a, idx) => {
      if (!a.revealed) socket.emit('admin:revealAnswer', { catIndex:ci, itemIndex:ii, index:idx });
    });
  };

  footer.appendChild(wrongBtn);
  footer.appendChild(revealAllBtn);
  answersDiv.appendChild(footer);
}

// *** Events ***

socket.on('state:update', (data) => {
  renderPlayers(data.players);
  renderBoard(data.board);
});

socket.on('state:admin', (data) => {
  renderPlayers(data.players);
  renderBoard(data.board);
  if (lastTile) renderAnswersAdmin(lastTile.ci, lastTile.ii, data.board);
});

// Globaler Start-Zug & Zugwechsel → Admin-UI markieren
socket.on('turn:global', (p) => {
  updateTurnUI(p.team);
});
socket.on('turn:changed', (p) => {
  updateTurnUI(p.turnTeam || p.team);
  if (lastTile && adminBoardCache) {
    renderAnswersAdmin(lastTile.ci, lastTile.ii, adminBoardCache);
  }
});

// NEU: Select/Lock-in-Sound sobald ein Feld gewählt/gestartet wurde
socket.on('tile:revealed', (p) => {
  const sel = document.getElementById('sfxSelect');
  if (sel) sel.play().catch(()=>{});
  lastTile = { ci:p.catIndex, ii:p.itemIndex };
});

// Sound + Live-Refresh der Antwortenzeile (ohne auf kompletten State zu warten)
socket.on('answer:revealed', (p) => {
  document.getElementById('sfxCorrect').play().catch(()=>{});
  if (adminBoardCache && lastTile && lastTile.ci===p.catIndex && lastTile.ii===p.itemIndex) {
    const it = adminBoardCache.categories?.[p.catIndex]?.items?.[p.itemIndex];
    if (it && it.answers?.[p.index]) {
      it.answers[p.index].revealed = true;
      it.answers[p.index].byTeam   = p.byTeam || null;
      renderAnswersAdmin(lastTile.ci, lastTile.ii, adminBoardCache);
    }
  }
});

socket.on('guess:wrong', () => {
  document.getElementById('sfxWrong').play().catch(()=>{});
});

socket.on('chat:spy', (m) => {
  const row = el('div', {class:'player ' + (m.from.team==='A' ? 'teamA' : 'teamB')},
    el('div', {}, `[Team ${m.from.team}] ${m.from.name}:`),
    el('div', {}, m.msg)
  );
  spyDiv.appendChild(row);
  spyDiv.scrollTop = spyDiv.scrollHeight;
});

// Gewinner-Animation bei allen Clients
socket.on('celebrate:winner', ({ team }) => {
  const who = team === 'A' ? 'Team Rot' : 'Team Blau';
  turnBanner.style.display = 'block';
  turnBanner.textContent = `🎉 Gewinner: ${who}`;
  confettiBurst(5200, team);
  setTimeout(()=> updateTurnUI(currentTurnTeam), 5400);
});

// *** Controls ***
document.getElementById('btnDraw').onclick  = () => socket.emit('admin:drawStartTeam');
document.getElementById('btnNext').onclick  = () => socket.emit('admin:nextRound');
document.getElementById('btnReload').onclick= () => location.reload();
document.getElementById('btnAward').onclick = () => {
  const id  = document.getElementById('awId').value.trim();
  const val = parseInt(document.getElementById('awVal').value || '0', 10);
  if (!id) return alert('Spieler-ID angeben');
  socket.emit('admin:awardPoints', { playerId:id, points:val });
};
document.getElementById('btnForce').onclick = () => {
  if (!lastTile) return alert('Kein Feld aktiv');
  socket.emit('admin:forceClose', { catIndex:lastTile.ci, itemIndex:lastTile.ii });
};

// Gewinner-Team anzeigen (Konfetti/Krone bei allen)
document.getElementById('btnCelebrate').onclick = () => {
  const t = document.getElementById('winTeam').value;
  if (t !== 'A' && t !== 'B') return;
  socket.emit('admin:celebrate', { team: t });
};
</script>
</body>
</html>
